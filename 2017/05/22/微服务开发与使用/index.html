<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Microservice架构模式就是将整个Web应用组织为一系列小的Web服务。这些小的Web服务可以独立地编译及部署，并通过各自暴露的API接口相互通讯。它们彼此相互协作，作为一个整体为用户提供功能，却可以独立地进行扩容。">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务使用">
<meta property="og:url" content="http://example.com/2017/05/22/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B8%8E%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="一条缝小眼睛的个人博客">
<meta property="og:description" content="Microservice架构模式就是将整个Web应用组织为一系列小的Web服务。这些小的Web服务可以独立地编译及部署，并通过各自暴露的API接口相互通讯。它们彼此相互协作，作为一个整体为用户提供功能，却可以独立地进行扩容。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://luminghub.github.io/images/imgs/microservice/koalaService/003.png">
<meta property="og:image" content="https://luminghub.github.io/images/imgs/microservice/koalaService/001.png">
<meta property="og:image" content="https://luminghub.github.io/images/imgs/microservice/koalaService/002.png">
<meta property="article:published_time" content="2017-05-21T16:00:00.000Z">
<meta property="article:modified_time" content="2023-08-28T02:26:03.117Z">
<meta property="article:author" content="小明同学">
<meta property="article:tag" content="Spring Cloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://luminghub.github.io/images/imgs/microservice/koalaService/003.png">


<link rel="canonical" href="http://example.com/2017/05/22/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B8%8E%E4%BD%BF%E7%94%A8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2017/05/22/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B8%8E%E4%BD%BF%E7%94%A8/","path":"2017/05/22/微服务开发与使用/","title":"微服务使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>微服务使用 | 一条缝小眼睛的个人博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">一条缝小眼睛的个人博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">微服务架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-cloud"><span class="nav-number">2.</span> <span class="nav-text">spring cloud</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">基础环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%BF%83-%E3%80%90Netflix-Eureka%E3%80%91"><span class="nav-number">3.1.</span> <span class="nav-text">服务中心 【Netflix Eureka】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E3%80%90Spring-Cloud-Config%E3%80%91"><span class="nav-number">3.2.</span> <span class="nav-text">配置中心 【Spring Cloud Config】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E5%85%B3-%E3%80%90Netflix-Zuul%E3%80%91"><span class="nav-number">3.3.</span> <span class="nav-text">网关 【Netflix Zuul】</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E8%80%85%E4%BD%BF%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">开发者使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">项目层次结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="nav-number">4.2.</span> <span class="nav-text">服务注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8pom-xml%E4%B8%AD%E5%BC%95%E5%85%A5maven%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-number">4.2.1.</span> <span class="nav-text">在pom.xml中引入maven依赖：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E5%90%AF%E5%8A%A8%E7%B1%BB%E4%B8%AD%E5%BC%95%E5%85%A5-EnableDiscoveryClient%E6%B3%A8%E8%A7%A3"><span class="nav-number">4.2.2.</span> <span class="nav-text">在启动类中引入@EnableDiscoveryClient注解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEapplication-properties"><span class="nav-number">4.2.3.</span> <span class="nav-text">配置application.properties</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">4.2.4.</span> <span class="nav-text">使用客户端负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.</span> <span class="nav-text">服务配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8pom%E4%B8%AD%E5%BC%95%E5%85%A5maven%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-number">4.3.1.</span> <span class="nav-text">在pom中引入maven依赖：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86application-properties%E4%BF%AE%E6%94%B9%E6%88%90bootstrap-properties%EF%BC%8C%E5%B9%B6%E5%8A%A0%E5%85%A5%E4%B8%8B%E5%88%97%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="nav-number">4.3.2.</span> <span class="nav-text">将application.properties修改成bootstrap.properties，并加入下列配置项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">4.3.3.</span> <span class="nav-text">将配置信息写入配置中心</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#health%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">4.4.</span> <span class="nav-text">health组件配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5health%E7%9A%84maven%E4%BE%9D%E8%B5%96"><span class="nav-number">4.4.1.</span> <span class="nav-text">引入health的maven依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEappinfo-properties"><span class="nav-number">4.4.2.</span> <span class="nav-text">配置appinfo.properties</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87javaagent%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">4.4.3.</span> <span class="nav-text">通过javaagent方式启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exception%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">4.5.</span> <span class="nav-text">exception组件配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5exception%E7%9A%84maven%E4%BE%9D%E8%B5%96"><span class="nav-number">4.5.1.</span> <span class="nav-text">引入exception的maven依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99BaseController%E7%B1%BB%E7%BB%A7%E6%89%BFServerExceptionHandle"><span class="nav-number">4.5.2.</span> <span class="nav-text">编写BaseController类继承ServerExceptionHandle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#controller%E7%BB%A7%E6%89%BFBaseController%EF%BC%8C%E5%B9%B6%E5%9C%A8rest-api%E6%96%B9%E6%B3%95%E4%B8%AD%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8"><span class="nav-number">4.5.3.</span> <span class="nav-text">controller继承BaseController，并在rest-api方法中抛出异常</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">4.6.</span> <span class="nav-text">log组件配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5log%E7%9A%84maven%E4%BE%9D%E8%B5%96"><span class="nav-number">4.6.1.</span> <span class="nav-text">引入log的maven依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AElog4j-properties%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">4.6.2.</span> <span class="nav-text">配置log4j.properties配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%97%A5%E5%BF%97%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.6.3.</span> <span class="nav-text">获取日志对象</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#swagger%E6%96%87%E6%A1%A3"><span class="nav-number">4.7.</span> <span class="nav-text">swagger文档</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8pom-xml%E4%B8%AD%E5%BC%95%E5%85%A5swagger%E7%9A%84maven%E4%BE%9D%E8%B5%96"><span class="nav-number">4.7.1.</span> <span class="nav-text">在pom.xml中引入swagger的maven依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96Docket%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.7.2.</span> <span class="nav-text">实例化Docket对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#swagger%E6%B3%A8%E8%A7%A3%E7%AE%80%E4%BB%8B"><span class="nav-number">4.7.3.</span> <span class="nav-text">swagger注解简介</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Api"><span class="nav-number">4.7.3.1.</span> <span class="nav-text">@Api</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ApiOperation"><span class="nav-number">4.7.3.2.</span> <span class="nav-text">@ApiOperation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ApiImplicitParams-ApiImplicitParam"><span class="nav-number">4.7.3.3.</span> <span class="nav-text">@ApiImplicitParams @ApiImplicitParam</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ApiParam"><span class="nav-number">4.7.3.4.</span> <span class="nav-text">@ApiParam</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ApiResponses-ApiResponse"><span class="nav-number">4.7.3.5.</span> <span class="nav-text">@ApiResponses @ApiResponse</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ApiModelProperty"><span class="nav-number">4.7.3.6.</span> <span class="nav-text">@ApiModelProperty</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ApiIgnore"><span class="nav-number">4.7.3.7.</span> <span class="nav-text">@ApiIgnore</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#generator%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="nav-number">4.8.</span> <span class="nav-text">generator代码生成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5generator%E5%8F%8Afeign%E7%9A%84maven%E4%BE%9D%E8%B5%96"><span class="nav-number">4.8.1.</span> <span class="nav-text">引入generator及feign的maven依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E7%94%9F%E6%88%90%E7%B1%BBMicroServiceGenerator"><span class="nav-number">4.8.2.</span> <span class="nav-text">编写生成类MicroServiceGenerator</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E4%BD%BF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">消费者使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E8%B0%83%E7%94%A8"><span class="nav-number">5.1.</span> <span class="nav-text">网关调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java-SDK%E8%B0%83%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text">java SDK调用</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小明同学"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">小明同学</p>
  <div class="site-description" itemprop="description">这个人的眼睛很小很小，笑起来的时候就会变成一条缝</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/22/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B8%8E%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="小明同学">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一条缝小眼睛的个人博客">
      <meta itemprop="description" content="这个人的眼睛很小很小，笑起来的时候就会变成一条缝">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="微服务使用 | 一条缝小眼睛的个人博客">
      <meta itemprop="description" content="Microservice架构模式就是将整个Web应用组织为一系列小的Web服务。这些小的Web服务可以独立地编译及部署，并通过各自暴露的API接口相互通讯。它们彼此相互协作，作为一个整体为用户提供功能，却可以独立地进行扩容。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微服务使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-05-22 00:00:00" itemprop="dateCreated datePublished" datetime="2017-05-22T00:00:00+08:00">2017-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-08-28 10:26:03" itemprop="dateModified" datetime="2023-08-28T10:26:03+08:00">2023-08-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Study/" itemprop="url" rel="index"><span itemprop="name">Study</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">Microservice架构模式就是将整个Web应用组织为一系列小的Web服务。这些小的Web服务可以独立地编译及部署，并通过各自暴露的API接口相互通讯。它们彼此相互协作，作为一个整体为用户提供功能，却可以独立地进行扩容。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h2><p>Microservice架构模式就是将整个Web应用组织为一系列小的Web服务。这些小的Web服务可以独立地编译及部署，并通过各自暴露的API接口相互通讯。它们彼此相互协作，作为一个整体为用户提供功能，却可以独立地进行扩容。</p>
<h2 id="spring-cloud"><a href="#spring-cloud" class="headerlink" title="spring cloud"></a>spring cloud</h2><p>Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等。</p>
<h2 id="基础环境搭建"><a href="#基础环境搭建" class="headerlink" title="基础环境搭建"></a>基础环境搭建</h2><p>目前微服务基础环境由三部分组成，包括服务中心、配置中心和网关。</p>
<p>服务中心用来有效管理服务的注册信息；配置中心用来集中管理各服务的配置信息；网关统一向外系统提供REST API服务。</p>
<p>使用的Spring Boot版本为 1.5.2.RELEASE。</p>
<h3 id="服务中心-【Netflix-Eureka】"><a href="#服务中心-【Netflix-Eureka】" class="headerlink" title="服务中心 【Netflix Eureka】"></a>服务中心 【Netflix Eureka】</h3><p>服务注册与发现，用到的是Spring Cloud Netflix，主要内容是对Netflix公司一系列开源产品的包装，它为Spring Boot应用提供了自配置的Netflix OSS整合。通过一些简单的注解，开发者就可以快速的在应用中配置一下常用模块并构建庞大的分布式系统。它主要提供的模块包括：服务发现（Eureka），断路器（Hystrix），智能路由（Zuul），客户端负载均衡（Ribbon、Feign）等。</p>
<p>创建一个基础的Spring Boot工程，并在pom.xml中引入需要的依赖内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在的Spring Boot应用中添加<code>@EnableEurekaServer</code>注解启动服务注册中功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(Application.class).web(<span class="literal">true</span>).run(args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在默认设置下，该服务注册中心也会将自己作为客户端来尝试注册它自己，所以我们需要禁用它的客户端注册行为，在application.properties添加<code>ureka.client.register-with-eureka=false</code>和<code>eureka.client.fetch-registry=false</code>。完整的application.properties配置信息如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server<span class="selector-class">.port</span>=<span class="number">8081</span></span><br><span class="line">eureka<span class="selector-class">.client</span><span class="selector-class">.register-with-eureka</span>=false</span><br><span class="line">eureka<span class="selector-class">.client</span><span class="selector-class">.fetch-registry</span>=false</span><br><span class="line">eureka<span class="selector-class">.client</span><span class="selector-class">.serviceUrl</span><span class="selector-class">.defaultZone</span>=http://localhost:$&#123;server<span class="selector-class">.port</span>&#125;/eureka/</span><br></pre></td></tr></table></figure>

<p>启动后，服务中心地址<code>http://host:port/</code></p>
<h3 id="配置中心-【Spring-Cloud-Config】"><a href="#配置中心-【Spring-Cloud-Config】" class="headerlink" title="配置中心 【Spring Cloud Config】"></a>配置中心 【Spring Cloud Config】</h3><p>Spring Cloud Config为服务端和客户端提供了分布式系统的外部化配置支持。配置服务器为各应用的所有环境提供了一个中心化的外部配置。配置服务器默认采用git来存储配置信息，这里我们使用mongodb来存储配置信息<a target="_blank" rel="noopener" href="https://github.com/spring-cloud-incubator/spring-cloud-config-server-mongodb">(更多信息)</a>。</p>
<p>创建Config Server工程，在pom.xml中引入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建Spring Boot的程序主类，并添加<code>@EnableConfigServer</code>注解，开启Config Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(Application.class).web(<span class="literal">true</span>).run(args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继承org.springframework.cloud.config.server.environment.EnvironmentRepository类，重写findOne方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Environment <span class="title function_">findOne</span><span class="params">(String application, String profile, String label)</span> &#123;</span><br><span class="line">  <span class="comment">//TODO </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="网关-【Netflix-Zuul】"><a href="#网关-【Netflix-Zuul】" class="headerlink" title="网关 【Netflix Zuul】"></a>网关 【Netflix Zuul】</h3><p>通过服务网关统一向外系统提供REST API的过程中，除了具备服务路由、均衡负载功能之外，它还具备了权限控制等功能。Spring Cloud Netflix中的Zuul就担任了这样的一个角色，为微服务架构提供了前门保护的作用，同时将权限控制这些较重的非业务逻辑内容迁移到服务路由层面，使得服务集群主体能够具备更高的可复用性和可测试性。</p>
<p>引入依赖spring-cloud-starter-zuul、spring-cloud-starter-eureka。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>应用主类使用<code>@EnableZuulProxy</code>注解开启Zuul</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringCloudApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">   <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(Application.class).web(<span class="literal">true</span>).run(args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@SpringCloudApplication</code>注解整合了<code>@SpringBootApplication</code>、<code>@EnableDiscoveryClient</code>、<code>@EnableCircuitBreaker</code></p>
<p>配置zuul通过serviceId映射，将网关注册到服务中心。</p>
<pre><code>eureka.client.serviceUrl.defaultZone=http://host:port/eureka/
</code></pre>
<p>自定义过滤器，继承ZuulFilter，需要实现四个方法：</p>
<p>filterType：返回一个字符串代表过滤器的类型，在zuul中定义了四种不同生命周期的过滤器类型，具体如下：</p>
<pre><code>pre：可以在请求被路由之前调用
routing：在路由请求时候被调用
post：在routing和error过滤器之后被调用
error：处理请求时发生错误时被调用
</code></pre>
<p>filterOrder：通过int值来定义过滤器的执行顺序</p>
<p>shouldFilter：返回一个boolean类型来判断该过滤器是否要执行，所以通过此函数可实现过滤器的开关。在上例中，我们直接返回true，所以该过滤器总是生效。</p>
<p>run：过滤器的具体逻辑。需要注意，这里我们通过ctx.setSendZuulResponse(false)令zuul过滤该请求，不对其进行路由，然后通过ctx.setResponseStatusCode(401)设置了其返回的错误码，当然我们也可以进一步优化我们的返回，比如，通过ctx.setResponseBody(body)对返回body内容进行编辑等。</p>
<p><img src="https://luminghub.github.io/images/imgs/microservice/koalaService/003.png"></p>
<p>实现了自定义过滤器之后，实例化该过滤器使其生效。</p>
<h2 id="开发者使用"><a href="#开发者使用" class="headerlink" title="开发者使用"></a>开发者使用</h2><h3 id="项目层次结构"><a href="#项目层次结构" class="headerlink" title="项目层次结构"></a>项目层次结构</h3><p>在顶层项目KOALA下面，创建对应的微服务module，命名规范为<code>koala-$&#123;servicename&#125;</code>。下面是服务提供者和服务消费者，命名规范为<code>koala-$&#123;servicename&#125;-service</code>、<code>koala-$&#123;servicename&#125;-sharelib</code>。具体结果如下图所示：</p>
<p><img src="https://luminghub.github.io/images/imgs/microservice/koalaService/001.png"></p>
<p>其依赖关系如下图所示：</p>
<p><img src="https://luminghub.github.io/images/imgs/microservice/koalaService/002.png"></p>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>将koala-servicename-service注册到服务中心。</p>
<h4 id="在pom-xml中引入maven依赖："><a href="#在pom-xml中引入maven依赖：" class="headerlink" title="在pom.xml中引入maven依赖："></a>在pom.xml中引入maven依赖：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="在启动类中引入-EnableDiscoveryClient注解"><a href="#在启动类中引入-EnableDiscoveryClient注解" class="headerlink" title="在启动类中引入@EnableDiscoveryClient注解"></a>在启动类中引入@EnableDiscoveryClient注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DisasterServerApp</span> &#123;</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    SpringApplication.run(DisasterServerApp.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置application-properties"><a href="#配置application-properties" class="headerlink" title="配置application.properties"></a>配置application.properties</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="selector-class">.application</span><span class="selector-class">.name</span>：注册的微服务SERVICEID</span><br><span class="line">spring<span class="selector-class">.cloud</span><span class="selector-class">.config</span><span class="selector-class">.profile</span>：配置文件profile属性，可以用来区分环境</span><br><span class="line">eureka<span class="selector-class">.client</span><span class="selector-class">.serviceUrl</span><span class="selector-class">.defaultZone</span>：微服务注册中心地址</span><br></pre></td></tr></table></figure>

<h4 id="使用客户端负载均衡"><a href="#使用客户端负载均衡" class="headerlink" title="使用客户端负载均衡"></a>使用客户端负载均衡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><p>将微服务配置信息写入配置中心。</p>
<h4 id="在pom中引入maven依赖："><a href="#在pom中引入maven依赖：" class="headerlink" title="在pom中引入maven依赖："></a>在pom中引入maven依赖：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="将application-properties修改成bootstrap-properties，并加入下列配置项"><a href="#将application-properties修改成bootstrap-properties，并加入下列配置项" class="headerlink" title="将application.properties修改成bootstrap.properties，并加入下列配置项"></a>将application.properties修改成bootstrap.properties，并加入下列配置项</h4><p>spring.cloud.config.label：服务端依赖的资源文件标记<br>spring.cloud.config.discovery.enabled：使用注册中心生效<br>spring.cloud.config.discovery.serviceId&#x3D;注册中心SERVICEID</p>
<h4 id="将配置信息写入配置中心"><a href="#将配置信息写入配置中心" class="headerlink" title="将配置信息写入配置中心"></a>将配置信息写入配置中心</h4><p>目前只能通过接口写入，写入的json格式实例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;application&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SERVICEID-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;profile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MICROSERVICE&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MASTER&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;postgre.driverClass&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.postgresql.Driver&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdbc:postgresql://10.10.10.10:5432/pql&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;username&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;password&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.initialPoolSize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.minPoolSize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.maxPoolSize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.acquireIncrement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.maxIdleTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;postgre.acquireRetryAttempts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;postgre.acquireRetryDelay&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;postgre.breakAfterAcquireFailure&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="health组件配置"><a href="#health组件配置" class="headerlink" title="health组件配置"></a>health组件配置</h3><p>health组件为公司内部基础组件，目前最新版本为：1.0.5。health的主要作用是将app注册到zookeeper中。报警程序通过监控zookeeper上注册的app状态及health接口判断app是否健康存活。</p>
<h4 id="引入health的maven依赖"><a href="#引入health的maven依赖" class="headerlink" title="引入health的maven依赖"></a>引入health的maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mlog<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharelibs-health<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置appinfo-properties"><a href="#配置appinfo-properties" class="headerlink" title="配置appinfo.properties"></a>配置appinfo.properties</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">productName：项目组名</span><br><span class="line">appGroup：服务组名</span><br><span class="line">appName：服务名称</span><br><span class="line">ip：注册IP</span><br><span class="line">port：服务端口</span><br><span class="line">frameWork：项目框架</span><br><span class="line">language：开发语言</span><br><span class="line">register<span class="selector-class">.zk</span><span class="selector-class">.servers</span>：zookeeper集群地址</span><br><span class="line">baseSleepTimeMs：注册间隔时间</span><br><span class="line">maxRetries：重试次数</span><br></pre></td></tr></table></figure>

<h4 id="通过javaagent方式启动"><a href="#通过javaagent方式启动" class="headerlink" title="通过javaagent方式启动"></a>通过javaagent方式启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -f lib/sharelibs-health*.jar ];<span class="keyword">then</span></span><br><span class="line">  healthAgent=`<span class="built_in">ls</span> -lrt lib/sharelibs-health-*.jar |awk -F<span class="string">&quot; &quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>`</span><br><span class="line">  AGENT_OPTS=<span class="string">&quot;<span class="variable">$AGENT_OPTS</span>  -javaagent:<span class="variable">$healthAgent</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="exception组件配置"><a href="#exception组件配置" class="headerlink" title="exception组件配置"></a>exception组件配置</h3><p>exception为公司内部基础组件，目前最新版本为：1.0.2。exception组件的主要作用是为服务端提供统一的异常处理机制。目前有<br><code>AuthorityException：权限异常</code>、<code>DataException：数据异常</code>、<code>ParamException：参数异常</code>、<code>RequestException：请求异常</code>、<code>ServerException：服务异常</code>五种异常类型。</p>
<h4 id="引入exception的maven依赖"><a href="#引入exception的maven依赖" class="headerlink" title="引入exception的maven依赖"></a>引入exception的maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mlog<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharelibs-exception<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="编写BaseController类继承ServerExceptionHandle"><a href="#编写BaseController类继承ServerExceptionHandle" class="headerlink" title="编写BaseController类继承ServerExceptionHandle"></a>编写BaseController类继承ServerExceptionHandle</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseController</span> <span class="keyword">extends</span> <span class="title class_">ServerExceptionHandle</span> &#123;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 异常处理</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@ExceptionHandler</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">exceptionHandle</span><span class="params">(Exception ex, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;MissingServletRequestParameterException&quot;</span>.equals(ex.getClass().getSimpleName())) &#123;</span><br><span class="line">      ex = ParamException.build(ParamError.ParamLosedError);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MethodArgumentTypeMismatchException&quot;</span>.equals(ex.getClass().getSimpleName())) &#123;</span><br><span class="line">      ex = ParamException.build(ParamError.ParamTypeError);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.exceptionHandle(ex, response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="controller继承BaseController，并在rest-api方法中抛出异常"><a href="#controller继承BaseController，并在rest-api方法中抛出异常" class="headerlink" title="controller继承BaseController，并在rest-api方法中抛出异常"></a>controller继承BaseController，并在rest-api方法中抛出异常</h4><p>可以通过五个异常类的build方法创建并抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataException.build(DataError.StatusError);</span><br><span class="line">DataException.build(DataError.StatusError, <span class="string">&quot;指定范围内不存在强对流天气&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="log组件配置"><a href="#log组件配置" class="headerlink" title="log组件配置"></a>log组件配置</h3><p>mlog-log组件为公司内部基础组件，目前最新版本为1.0.6。log组件的作用是将日志及异常信息用logstash抓取到指定目录，提供日志的可视化检索。</p>
<h4 id="引入log的maven依赖"><a href="#引入log的maven依赖" class="headerlink" title="引入log的maven依赖"></a>引入log的maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mlog.log<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mlog-log<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置log4j-properties配置文件"><a href="#配置log4j-properties配置文件" class="headerlink" title="配置log4j.properties配置文件"></a>配置log4j.properties配置文件</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#root</span></span><br><span class="line">log4j<span class="selector-class">.rootLogger</span>= INFO, console</span><br><span class="line">	</span><br><span class="line"><span class="selector-id">#your</span> app conf</span><br><span class="line">log4j<span class="selector-class">.logger</span><span class="selector-class">.com</span><span class="selector-class">.mlog</span><span class="selector-class">.koala</span><span class="selector-class">.aqi</span>=INFO, console, file</span><br><span class="line">log4j<span class="selector-class">.additivity</span><span class="selector-class">.com</span><span class="selector-class">.mlog</span><span class="selector-class">.koala</span><span class="selector-class">.aqi</span>=false</span><br><span class="line">	</span><br><span class="line"><span class="selector-id">#console</span></span><br><span class="line">log4j<span class="selector-class">.appender</span><span class="selector-class">.console</span>=org<span class="selector-class">.apache</span><span class="selector-class">.log4j</span><span class="selector-class">.ConsoleAppender</span></span><br><span class="line">log4j<span class="selector-class">.appender</span><span class="selector-class">.console</span><span class="selector-class">.Threshold</span>=INFO</span><br><span class="line">log4j<span class="selector-class">.appender</span><span class="selector-class">.console</span><span class="selector-class">.layout</span>=com<span class="selector-class">.mlog</span><span class="selector-class">.log</span><span class="selector-class">.layout</span><span class="selector-class">.EasyPatternLayout</span></span><br><span class="line">log4j<span class="selector-class">.appender</span><span class="selector-class">.console</span><span class="selector-class">.layout</span><span class="selector-class">.ConversionPattern</span>=%d&#123;yyyy-MM-<span class="selector-tag">dd</span> HH:mm:ss&#125; %<span class="number">5</span>p <span class="selector-attr">[%8t]</span> %<span class="number">50.50</span>c : %m%n</span><br><span class="line">	</span><br><span class="line">#file to be caught</span><br><span class="line">log4j.appender.file=com.mlog.log.appender.RollingFileAppender</span><br><span class="line">log4j.appender.file.Threshold=info</span><br><span class="line">log4j.appender.file.layout=com.mlog.log.layout.NullPatternLayout</span><br><span class="line">	</span><br><span class="line">#your log default product and app</span><br><span class="line">mlog.product：项目名</span><br><span class="line">mlog.app：app名字</span><br><span class="line">mlog.flag：app分类</span><br><span class="line">#your error uncaught to</span><br><span class="line">mlog.err.dir：错误日志列印位置</span><br><span class="line">#your log file to</span><br><span class="line">mlog.log.dir：日志列印位置</span><br><span class="line">#alertcenter http url</span><br><span class="line">mlog.alertcenter.url：服务地址</span><br></pre></td></tr></table></figure>

<h4 id="获取日志对象"><a href="#获取日志对象" class="headerlink" title="获取日志对象"></a>获取日志对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(Class.class)</span><br></pre></td></tr></table></figure>

<h3 id="swagger文档"><a href="#swagger文档" class="headerlink" title="swagger文档"></a>swagger文档</h3><p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。</p>
<h4 id="在pom-xml中引入swagger的maven依赖"><a href="#在pom-xml中引入swagger的maven依赖" class="headerlink" title="在pom.xml中引入swagger的maven依赖"></a>在pom.xml中引入swagger的maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="实例化Docket对象"><a href="#实例化Docket对象" class="headerlink" title="实例化Docket对象"></a>实例化Docket对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select()</span><br><span class="line">	      .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.mlog.koala.disaster.controller&quot;</span>))</span><br><span class="line">	      .paths(PathSelectors.any()).build();</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>().title(<span class="string">&quot;强对流天气临近预报查询在线API文档&quot;</span>).description(<span class="string">&quot;由@象辑科技发布&quot;</span>)</span><br><span class="line">	      .license(<span class="string">&quot;Apache 2.0&quot;</span>).licenseUrl(<span class="string">&quot;http://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>)</span><br><span class="line">	      .termsOfServiceUrl(<span class="string">&quot;http://www.mlogcn.com/&quot;</span>).contact(<span class="string">&quot;象辑科技&quot;</span>).version(<span class="string">&quot;1.0.1&quot;</span>).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="swagger注解简介"><a href="#swagger注解简介" class="headerlink" title="swagger注解简介"></a>swagger注解简介</h4><h5 id="Api"><a href="#Api" class="headerlink" title="@Api"></a>@Api</h5><p>value </p>
<blockquote>
<p>controller的描述信息；</p>
</blockquote>
<p>tags </p>
<blockquote>
<p>controller的名称；</p>
</blockquote>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;提供用户基本信息的增删改查操作接口&quot;, tags = &#123; &quot;用户接口&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ApiOperation"><a href="#ApiOperation" class="headerlink" title="@ApiOperation"></a>@ApiOperation</h5><p>produces</p>
<blockquote>
<p>返回的格式类型</p>
</blockquote>
<p>consumes</p>
<blockquote>
<p>接收的格式类型</p>
</blockquote>
<p>value</p>
<blockquote>
<p>主要描述信息</p>
</blockquote>
<p>notes</p>
<blockquote>
<p>详细描述信息</p>
</blockquote>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;获取用户列表&quot;, notes = &quot;获取当前数据库中存储的全部用户信息&quot;, produces=&quot;application/json&quot;, consumes = &quot;application/json&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getAllUserList</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h5 id="ApiImplicitParams-ApiImplicitParam"><a href="#ApiImplicitParams-ApiImplicitParam" class="headerlink" title="@ApiImplicitParams @ApiImplicitParam"></a>@ApiImplicitParams @ApiImplicitParam</h5><p>paramType</p>
<blockquote>
<p>有3种类型，query、path、body；分别对应spring中的@RequestParam 、@PathVariable 、@RequestBody</p>
</blockquote>
<p>name</p>
<blockquote>
<p>参数名称</p>
</blockquote>
<p>value</p>
<blockquote>
<p>参数描述信息</p>
</blockquote>
<p>defaultValue</p>
<blockquote>
<p>默认值</p>
</blockquote>
<p>required</p>
<blockquote>
<p>是否必传</p>
</blockquote>
<p>dataType</p>
<blockquote>
<p>数据类型</p>
</blockquote>
<p>allowableValues</p>
<blockquote>
<p>允许输入的值；目前好像只针对String类型的有效</p>
</blockquote>
<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiImplicitParams(&#123;</span></span><br><span class="line"><span class="meta">  @ApiImplicitParam(allowableValues = &quot;zhangsan, lisi&quot;, paramType = &quot;query&quot;, name = &quot;username&quot;, value = &quot;用户姓名&quot;, defaultValue = &quot;zhangsan&quot;, required = true, dataType = &quot;String&quot;),</span></span><br><span class="line"><span class="meta">  @ApiImplicitParam(paramType = &quot;path&quot;, name = &quot;id&quot;, value = &quot;用户ID&quot;, defaultValue = &quot;1001&quot;, required = true, dataType = &quot;Long&quot;),</span></span><br><span class="line"><span class="meta">  @ApiImplicitParam(paramType = &quot;body&quot;, name = &quot;user&quot;, value = &quot;用户详细信息&quot;, required = true, dataType = &quot;User&quot;) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">updateUser</span><span class="params">(<span class="meta">@RequestParam(name = &quot;username&quot;)</span> String username, <span class="meta">@PathVariable</span> Long id, <span class="meta">@RequestBody</span> User user)</span>;</span><br></pre></td></tr></table></figure>

<h5 id="ApiParam"><a href="#ApiParam" class="headerlink" title="@ApiParam"></a>@ApiParam</h5><p>同@ApiImplicitParams @ApiImplicitParam，不过更简化，推荐使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiParam(&quot;开始时间，格式yyyyMMddHHmm&quot;)</span></span><br></pre></td></tr></table></figure>

<h5 id="ApiResponses-ApiResponse"><a href="#ApiResponses-ApiResponse" class="headerlink" title="@ApiResponses @ApiResponse"></a>@ApiResponses @ApiResponse</h5><p>code</p>
<blockquote>
<p>httpCode编码</p>
</blockquote>
<p>message</p>
<blockquote>
<p>描述信息</p>
</blockquote>
<p>response</p>
<blockquote>
<p>返回数据类型</p>
</blockquote>
<p>responseContainer</p>
<blockquote>
<p>返回数据类型容器，可以选择 List Set Map</p>
</blockquote>
<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiResponses(value = &#123;@ApiResponse(code = 400, message = &quot;参数异常&quot;, response = ErrorBean.class),</span></span><br><span class="line"><span class="meta">@ApiResponse(code = 500, message = &quot;服务异常&quot;, response = ErrorBean.class),</span></span><br><span class="line"><span class="meta">@ApiResponse(code = 401, message = &quot;权限异常&quot;, response = ErrorBean.class),</span></span><br><span class="line"><span class="meta">@ApiResponse(code = 404, message = &quot;数据异常&quot;, response = ErrorBean.class)&#125;)</span></span><br></pre></td></tr></table></figure>

<h5 id="ApiModelProperty"><a href="#ApiModelProperty" class="headerlink" title="@ApiModelProperty"></a>@ApiModelProperty</h5><p>实体类属性上使用的注解，建议只使用value属性。</p>
<p>value</p>
<blockquote>
<p>属性列描述信息</p>
</blockquote>
<h5 id="ApiIgnore"><a href="#ApiIgnore" class="headerlink" title="@ApiIgnore"></a>@ApiIgnore</h5><p>用来标注不使用swagger的API方法。</p>
<p>完整示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/mete/disaster/forecast&quot;)</span></span><br><span class="line"><span class="meta">@Api(value = &quot;DISASTER&quot;, tags = &#123;&quot;强对流天气临近预报查询API&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DisasterDataController</span> <span class="keyword">extends</span> <span class="title class_">BaseController</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> IDisasterDataService disasterDataService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation(value = &quot;雷电预报全量查询&quot;, produces = &quot;application/json&quot;,</span></span><br><span class="line"><span class="meta">	      notes = &quot;查询输入的时间区间（闭区间）范围内全部的雷电预报数据&quot;)</span></span><br><span class="line">  <span class="meta">@ApiResponses(value = &#123;@ApiResponse(code = 400, message = &quot;参数异常&quot;, response = ErrorBean.class),</span></span><br><span class="line"><span class="meta">  @ApiResponse(code = 500, message = &quot;服务异常&quot;, response = ErrorBean.class),</span></span><br><span class="line"><span class="meta">  @ApiResponse(code = 401, message = &quot;权限异常&quot;, response = ErrorBean.class),</span></span><br><span class="line"><span class="meta">  @ApiResponse(code = 404, message = &quot;数据异常&quot;, response = ErrorBean.class)&#125;)</span></span><br><span class="line">  <span class="meta">@RequestMapping(value = &quot;/thunder/all&quot;, method = RequestMethod.GET)</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;DisasterItem&gt; <span class="title function_">queryAllThunderDisaster</span><span class="params">(</span></span><br><span class="line"><span class="params">	    <span class="meta">@ApiParam(&quot;开始时间，格式yyyyMMddHHmm&quot;)</span> <span class="meta">@RequestParam(&quot;start&quot;)</span> <span class="meta">@DateTimeFormat(</span></span></span><br><span class="line"><span class="meta"><span class="params">	        pattern = &quot;yyyyMMddHHmm&quot;)</span> Date startTime,</span></span><br><span class="line"><span class="params">	    <span class="meta">@ApiParam(&quot;结束时间，格式yyyyMMddHHmm&quot;)</span> <span class="meta">@RequestParam(&quot;end&quot;)</span> <span class="meta">@DateTimeFormat(</span></span></span><br><span class="line"><span class="meta"><span class="params">	        pattern = &quot;yyyyMMddHHmm&quot;)</span> Date endTime)</span></span><br><span class="line">	    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> disasterDataService.queryAllDisaster(<span class="string">&quot;thunder&quot;</span>, startTime, endTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="generator代码生成"><a href="#generator代码生成" class="headerlink" title="generator代码生成"></a>generator代码生成</h3><p>generator是专门为微服务生成对应的java SDK的，目前最新版本为1.1.0。</p>
<h4 id="引入generator及feign的maven依赖"><a href="#引入generator及feign的maven依赖" class="headerlink" title="引入generator及feign的maven依赖"></a>引入generator及feign的maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mlog.koala<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>koala-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="编写生成类MicroServiceGenerator"><a href="#编写生成类MicroServiceGenerator" class="headerlink" title="编写生成类MicroServiceGenerator"></a>编写生成类MicroServiceGenerator</h4><p>需要配置的4个参数：</p>
<p>appName：微服务的SERVICEID;</p>
<p>scanPackage：需要扫描的controller的包路径；</p>
<p>targetPackage：需要生成的SDK service路径；</p>
<p>creatPath：SDK service生成的跟目录；</p>
<p>完整示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MicroServiceGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> <span class="string">&quot;DISASTERSERVICE-1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">scanPackage</span> <span class="operator">=</span> <span class="string">&quot;com.mlog.koala.disaster.controller&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">targetPackage</span> <span class="operator">=</span> <span class="string">&quot;com.mlog.koala.disaster.service&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">creatPath</span> <span class="operator">=</span> filePath.replaceAll(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;sharelib&quot;</span>);</span><br><span class="line">	<span class="type">SDKGreneratorServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SDKGreneratorServer</span>(appName, scanPackage, targetPackage, creatPath);</span><br><span class="line">	server.creat();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="消费者使用"><a href="#消费者使用" class="headerlink" title="消费者使用"></a>消费者使用</h2><p>目前微服务支持以下两种调用方式：</p>
<p>通过ServiceID走微服务网关调用；通过java SDK调用。</p>
<h3 id="网关调用"><a href="#网关调用" class="headerlink" title="网关调用"></a>网关调用</h3><p>通过SERVICEID及服务的url地址，从网关中调用rest-api服务。<br>调用规则为</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://api-gateway/SERVICEID/VERSION/path</span><br></pre></td></tr></table></figure>

<p>如：<br>假设微服务网关host地址为 <a href="http://10.10.10.10:8080，">http://10.10.10.10:8080，</a><br>微服务A的SERVICEID为:APP-1，其中有一个接口地址为 &#x2F;hello&#x2F;world，那么网关的调取地址为：</p>
<p><code>http://10.10.10.10:8080/APP/v1/hello/world</code></p>
<p>注意：为了规范url调取路径，serviceid和版本将统一转换为小写</p>
<h3 id="java-SDK调用"><a href="#java-SDK调用" class="headerlink" title="java SDK调用"></a>java SDK调用</h3><p>在pom.xml中引入对应的微服务发布的SDK包（sharelib），注意不能使用@ComponentScan扫描Feigin接口<br>&#x2F;&#x2F; @EnableFeignClients(basePackageClasses &#x3D; NationStationService.class)<br>@EnableFeignClients(basePackages &#x3D; “com.mlog.koala.meta.service*”)<br>@EnableEurekaClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="comment">// @EnableFeignClients(basePackageClasses = NationStationService.class)</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.mlog.koala.meta.service*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMicroApp</span> &#123;</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    SpringApplication.run(TestMicroApp.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在配置文件中加入服务中心的地址，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.serviceUrl.defaultZone</span><br></pre></td></tr></table></figure>

<p>自动注入Service接口对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> NationStationService nationStationService;</span><br></pre></td></tr></table></figure>





    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spring-Cloud/" rel="tag"># Spring Cloud</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/05/20/java%E5%8F%8D%E5%B0%84/" rel="prev" title="java反射">
                  <i class="fa fa-angle-left"></i> java反射
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2017/05/24/Shell%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" rel="next" title="Shell编程基础">
                  Shell编程基础 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">小明同学</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
